# 渲染

渲染步骤：
1. 建立`图层树(Layer Tree)`
2. 生成`绘制列表`
3. 生成`图块`并`栅格化`
4. 显示器显示内容

## 建图层树

- 考虑到一些复杂的场景（如：3D动画如何呈现出变换效果，当元素含有层叠上下文时如何控制显示和隐藏等），浏览器在构建完布局树后，会对特定的节点进行分层，构建一棵`图层树`。
- 节点的图层会默认属于父节点的图层(合成层)，显式合成和隐式合成会提升为一个单独的合成层。

### 显式合成

1. 拥有**层叠上下文**的节点
    1. HTML根元素本身就具有层叠上下文
    2. 普通元素设置position不为static并且设置了z-index属性(auto不会)，会产生层叠上下文
    3. 元素opacity值不是1
    4. 元素的transform不是none
    5. 元素的filter值（模糊属性）不是none
    6. 元素的isolation值是isolate
    7. will-change指定的属性值为上面任意一个。
2. 需要**裁剪**的地方
    
    比如一个div，只设置100*100像素的大小，里面内容超出了div范围就需要被裁剪，如果出现滚动条，那么滚动条会被单独提升为一个图层。

### 隐式合成

`层叠等级低`的节点被提升为单独的图层之后，那么`所有层叠等级比它高`的节点都会成为一个单独的图层。这可能会导致**层爆炸**
- 注意：当需要`repaint`时，只需要`repaint`本身，而不会影响到其他的层。

## 生成绘制表

渲染引擎会将图层的绘制拆分成一个个绘制指令，比如先画背景、再描绘边框...然后将这些指令按顺序合成一个待绘制列表，相当于给后面的绘制操作做了一波计划。
- chrome开发者工具中more tools的layers面板可以看见绘制列表

## 生成图块和生成位图

在渲染进程中绘制操作是由专门的线程完成的，这个线程叫**合成线程**

绘制列表准备好以后，渲染进程的主线程会给`合成线程`发送`commit`消息，把绘制列表提交给合成线程。

考虑到性能，合成线程会将图层分块（通常256 * 256或者512 * 512一块）来加速首屏展示。

图块数据进入GPU内存，由于浏览器内存上传到GPU内存的操作比较慢，即使绘制一部分图块，也可能会耗费大量时间。chrome采用了一个策略：首次合成图块时采用一个**低分辨率**的图片，这样首屏展示的时候只展示低分辨率的图片，然后继续进行合成操作，当正常的图块内容绘制完毕后，会将当前分辨率的图块内容替换，就可以加速首屏渲染。

渲染进程中专门维护了一个`栅格化线程池`，专门负责把`图块`转换为`位图数据`,
然后合成线程会选择视口附近的`图块`，把它交给`栅格化线程池`生成图块和生成位图，生成位图的过程实际上都会使用GPU进行加速，生成的位图最后发送给`合成线程`

## 显示器显示内容

栅格化操作完成后，**合成线程**会生成一个绘制命令，即“DrawQuad”，并发送给浏览器进程。

浏览器进程中的`viz组件`接收到这个命令，根据这个命令，把页面内容绘制到内存，也就生成了页面，然后把这部分内存发送给显卡。